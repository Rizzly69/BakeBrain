<div class="header">
    <div class="header-content">
        <div class="header-left">
            <button class="mobile-menu-btn" style="display: none;">
                <i data-feather="menu"></i>
            </button>
            <h1 class="header-title">
                {% block header_title %}
                    {% if request.endpoint == 'dashboard' %}
                        Dashboard
                    {% elif request.endpoint == 'orders' %}
                        Orders
                    {% elif request.endpoint == 'inventory' %}
                        Inventory
                    {% elif request.endpoint == 'products' %}
                        Products
                    {% elif request.endpoint == 'catering' %}
                        Catering
                    {% elif request.endpoint == 'customers' %}
                        Customers
                    {% elif request.endpoint == 'staff' %}
                        Staff
                    {% elif request.endpoint == 'reports' %}
                        Reports
                    {% elif request.endpoint == 'profile' %}
                        Profile
                    {% else %}
                        Smart Bakery Management
                    {% endif %}
                {% endblock %}
            </h1>
        </div>
        
        <div class="user-menu">
            <div class="user-info">
                <div style="text-align: right;">
                    <div style="font-weight: 600; color: var(--text-primary);">
                        {{ current_user.first_name }} {{ current_user.last_name }}
                    </div>
                    <div style="font-size: 12px; color: var(--neon-cyan);">
                        {{ current_user.role.name.title() }}
                    </div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Notifications -->
                <div class="notification-bell" style="position: relative;">
                    <button class="btn-icon" id="notification-bell-btn" data-tooltip="Notifications" type="button">
                        <i data-feather="bell" style="width: 20px; height: 20px;"></i>
                        <span class="notification-badge" id="notification-badge" style="position: absolute; top: -5px; right: -5px; background: var(--error); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: none; align-items: center; justify-content: center;">0</span>
                    </button>
                    <div class="dropdown-menu" id="notification-pane" style="display: none; position: absolute; top: 110%; right: 0; background: var(--bg-card); border: 1px solid var(--bg-tertiary); border-radius: 8px; padding: 10px; box-shadow: var(--shadow-dark); z-index: 1000; min-width: 300px; max-width: 350px; max-height: 400px; overflow-y: auto;">
                        <div id="notification-list">
                            <div style="text-align:center; color:var(--text-secondary); font-size:14px;">Loading...</div>
                        </div>
                        <div style="text-align:right; margin-top:8px;">
                            <button class="btn-icon" id="mark-all-read-btn" style="font-size:12px;">Mark all as read</button>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                {% if current_user.role.name in ['admin', 'manager', 'staff'] %}
                <div class="quick-actions" style="display: flex; gap: 10px;">
                    <a href="{{ url_for('new_order') }}" class="btn-icon" data-tooltip="New Order">
                        <i data-feather="plus" style="width: 20px; height: 20px;"></i>
                    </a>
                </div>
                {% endif %}
                
                <!-- User Dropdown -->
                <div class="user-dropdown" style="position: relative;">
                    <button class="btn-icon" onclick="toggleUserDropdown()" data-tooltip="User Menu">
                        <i data-feather="user" style="width: 20px; height: 20px;"></i>
                    </button>
                    <div class="dropdown-menu" id="user-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: var(--bg-card); border: 1px solid var(--bg-tertiary); border-radius: 8px; padding: 10px; box-shadow: var(--shadow-dark); z-index: 1000; min-width: 150px;">
                        <a href="{{ url_for('profile') }}" class="dropdown-item">
                            <i data-feather="settings" style="width: 14px; height: 14px; margin-right: 8px;"></i>
                            Profile
                        </a>
                        <div class="dropdown-divider" style="border-top: 1px solid var(--bg-tertiary); margin: 8px 0;"></div>
                        <a href="{{ url_for('logout') }}" class="dropdown-item" style="color: var(--error);">
                            <i data-feather="log-out" style="width: 14px; height: 14px; margin-right: 8px;"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-icon {
    background: transparent;
    border: 1px solid var(--bg-tertiary);
    color: var(--text-secondary);
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-icon:hover {
    border-color: var(--neon-cyan);
    color: var(--neon-cyan);
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
}

.dropdown-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.dropdown-item:hover {
    background: var(--bg-tertiary);
    color: var(--neon-cyan);
}

.mobile-menu-btn {
    background: transparent;
    border: 1px solid var(--bg-tertiary);
    color: var(--text-secondary);
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    margin-right: 15px;
}

.mobile-menu-btn:hover {
    border-color: var(--neon-cyan);
    color: var(--neon-cyan);
}

@media (max-width: 768px) {
    .mobile-menu-btn {
        display: block !important;
    }
    
    .header-content {
        flex-direction: row;
        gap: 0;
    }
    
    .user-menu {
        flex-direction: row;
        gap: 10px;
    }
    
    .user-info {
        display: none;
    }
}
</style>


<script>
// Notification dropdown logic
const notificationBellBtn = document.getElementById('notification-bell-btn');
const notificationPane = document.getElementById('notification-pane');
const notificationBadge = document.getElementById('notification-badge');
const notificationList = document.getElementById('notification-list');
const markAllReadBtn = document.getElementById('mark-all-read-btn');

function fetchNotifications() {
    fetch('/api/notifications')
        .then(res => res.json())
        .then(data => {
            // Update badge
            if (data.unread_count > 0) {
                notificationBadge.textContent = data.unread_count;
                notificationBadge.style.display = 'flex';
            } else {
                notificationBadge.style.display = 'none';
            }
            // Render notifications
            if (data.notifications.length === 0) {
                notificationList.innerHTML = '<div style="text-align:center; color:var(--text-secondary); font-size:14px;">No new notifications</div>';
            } else {
                notificationList.innerHTML = data.notifications.map(n => `
                    <div style="padding:8px 0; border-bottom:1px solid var(--bg-tertiary); color:${n.is_read ? 'var(--text-secondary)' : 'var(--text-primary)'}; background:${n.is_read ? 'transparent' : 'var(--bg-tertiary)'};">
                        <div style="font-size:14px;">${n.message}</div>
                        <div style="font-size:11px; color:var(--neon-cyan);">${n.created_at}</div>
                    </div>
                `).join('');
            }
        });
}

function toggleNotifications() {
    if (notificationPane.style.display === 'none') {
        notificationPane.style.display = 'block';
        fetchNotifications();
    } else {
        notificationPane.style.display = 'none';
    }
}

if (notificationBellBtn) {
    notificationBellBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleNotifications();
    });
}
if (markAllReadBtn) {
    markAllReadBtn.addEventListener('click', function(e) {
        fetch('/api/notifications/mark_read', {method: 'POST'})
            .then(() => {
                fetchNotifications();
            });
    });
}

// Close notification pane when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.notification-bell')) {
        notificationPane.style.display = 'none';
    }
});

function toggleUserDropdown() {
    const dropdown = document.getElementById('user-dropdown');
    const isVisible = dropdown.style.display !== 'none';
    
    // Close all dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(d => {
        d.style.display = 'none';
    });
    
    // Show the user dropdown if it wasn't visible
    if (!isVisible) {
        dropdown.style.display = 'block';
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.user-dropdown')) {
        document.querySelectorAll('.dropdown-menu').forEach(d => {
            d.style.display = 'none';
        });
    }
});
</script>
